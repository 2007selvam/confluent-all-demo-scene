= Building a Streaming Data Pipeline with Kafka Streams and KSQL
Ricardo Ferreira<ricardo@confluent.io>, Viktor Gamov <viktor@confluent.io>, © 2019 Confluent, Inc.
:toc: auto
:toc-placement: auto
:toc-position: right
:toc-title: Table of content
:icons: font
:source-highlighter: highlight.js
:highlightjs-theme: idea
:experimental:

== Prerequisites

Welcome to the https://www.jfokus.se/jfokus19/talks/2585[«Building a Streaming Data Pipeline with Kafka Streams and KSQL»] workshop.

To be successful in executing all exercises, you need to have following installed.

* Docker CE Version 18.09.1
+
NOTE: It is OK to use Windows, but the trainers are not Windows users and may not be able to help with Windows related issues.
* Git
* JDK (min JDK 8)
** Recommended way
*** Install https://sdkman.io/install[sdkman]
*** `sdk list java`
*** `sdk install java <verison-provider>` e.g. `sdk install java 8.0.201-zulu`
* https://www.jetbrains.com/idea/download/[IntelliJ IDEA Community Edition]
* https://docs.docker.com/install/[Docker CE]
* Docker Compose Version 1.20.0 | with Docker Compose file format 2.1
* https://docs.confluent.io/current/cloud-quickstart.html#step-2-install-ccloud-cli[Confluent Cloud CLI]
* https://confluent.cloud[An initialized Confluent Cloud Cluster used for Development Only]

== Creating a Cluster in Confluent Cloud

In this section, you are going to create your own Apache Kafka cluster on Confluent Cloud. This cluster will be used troughout the entire workshop -- therefore make sure to follow the steps shown here.

=== Step 1: Log in to Confluent Cloud

Open the following URL in your browser: https://confluent.cloud/login[https://confluent.cloud/login]

Enter with the following credentials:

[source,bash]
----
Username: viktor+jfokus@confluent.io
Password: *************
----

The instructors will provide the password for this account.

=== Step 2: Create your Cluster

From the main UI, click on the `Add Cluster` button.

image:images/creating-cluster-1.png[Creating Cluster]

Enter with a value for the `Cluster name` field. To be able to identify your own cluster among the others, use the following notation for the name: firstName + '-' + lastName.

Make sure to select `Google Cloud Platform` as your Cloud provider. Though any cloud provider would work, we are using GCP in this workshop because it is cheaper. Finally, make sure to select `us-central-1` [EU West (London)] as region, since it is the closest location to Stockholm/Sweden. The image below shows an example of how your cluster should look like.

image:images/creating-cluster-2.png[Creating Cluster]

When you finish done the changes, click in the `Continue` button. The UI will ask for credit card details. Ask for some of the instructors to enter a valid credit card.

image:images/creating-cluster-3.png[Creating Cluster]

Finally, click on the `Save and launch cluster` button.

=== Step 3: Configure the Confluent Cloud CLI

From the main UI, click on your cluster. Then, click on the `Data In/Out` menu and subsequentially on the `CLI` sub-menu. You will be presented with the following instructions:

image:images/configure-ccloud-cli-1.png[Configuring Confluent Cloud CLI]

Follow the instructions presented thoroughly. This is crucial for the next sections of the workshop to work. If you feel that you need help, please don't hesitate to call any of the instructors.

== Creating Topics and Validating Data Flowing

=== Creating Raw Data Topics

[source,bash]
----
$ ccloud topic create raw-movies --partitions 16 --replication-factor 3
$ ccloud topic create raw-ratings --partitions 16 --replication-factor 3
----

Check if the topics were created properly by using the following command:

[source,bash]
----
$ ccloud topic list
----

You should see the two topics being listed in the output.

=== Producing and Consuming Data using Confluent Cloud CLI

Open a terminal to consume records from the `raw-movies` topic using the following command:

[source,bash]
----
$ ccloud consume -t raw-movies
----

Open another terminal to produce records to the `raw-movies` topic using the following command:

[source,bash]
----
$ cat ../data/movies.dat | ccloud produce -t raw-movies
----

Open another terminal to consume records from the `raw-ratings` topic using the following command:

[source,bash]
----
$ ccloud consume -t raw-ratings
----

Open another terminal to produce records to the `raw-ratings` topic using the following command:

[source,bash]
----
$ cat ../data/ratings.dat | ccloud produce -t raw-ratings
----

Press kbd:[Ctrl + C] to interrupt the consume commands issue in this section.

=== Creating Workshop Related Topics

[source,bash]
----
$ sh create-demo-topics.sh
----

You should see the following output:

[source,bash]
----
Topic "movies" created.
Topic "rating-sums" created.
Topic "rating-counts" created.
Topic "average-ratings" created.
Topic "rated-movies" created.
----

== Connecting Docker with Confluent Cloud Cluster

NOTE: Use this in a _non-production_ Confluent Cloud instance for development purposes only.

On the host from which you are running Docker, ensure that you have correctly initialized Confluent Cloud CLI and have a valid configuration file at `$HOME/.ccloud/config`. More information https://docs.confluent.io/current/cloud/cli/install.html[here].

=== Step 1: Generate a file that exports environment variables used by Docker to set up the bootstrap servers and authentication details.

[source,bash]
----
$ sh ccloud-generate-env-vars.sh
----

=== Step 2: Source the generated file to make the exports available in the current path.

[source,bash]
----
$ source ./delta_configs/env.delta
----


== Bring up Services from Confluent Platform

Make sure you completed the steps in the Setup section above before proceeding.
You may bring up all services in the Docker Compose file at once...

=== All Services At-Once

[source,bash]
----
$ docker-compose up -d
----

=== ...or individually...

==== Confluent Schema Registry

[source,bash]
----
$ docker-compose up -d schema-registry
----

==== KSQL Server

[source,bash]
----
$ docker-compose up -d ksql-server
----

==== KSQL CLI

[source,bash]
----
$ docker-compose up -d ksql-cli
----

==== Confluent Control Center

[source,bash]
----
$ docker-compose up -d control-center
----

Control Center may take from one to five minutes until the service finish start up, depending on your hardware configuration. To check if things are working properly, open the following URL in a browser: http://localhost:9021[http://localhost:9021]. If the Control Center UI pop's up, click on the `Topics` menu. You should be able to see the topics created previously.

image:images/c3-showing-topics.png[C3 Showing Topics]

If you need to troubleshoot what is going on with a particular service, you can use the command `docker-compose logs -f <SERVICE>`. For instance, the example below shows how to access the logs from Control Center:

[source,bash]
----
$ docker-compose logs -f control-center
----

== Validate If KSQL Server Is Working Properly

Before moving forward with this workshop you need to validate if KSQL is working as expected.
Thus, bring up the KSQL CLI using the command below:

[source,bash]
----
$ docker run --network workshop_default --rm --interactive --tty confluentinc/cp-ksql-cli:5.1.0 http://ksql-server:8088
----

You should be presented with a prompt as shown below:

[source,bash]
----

                  ===========================================
                  =        _  __ _____  ____  _             =
                  =       | |/ // ____|/ __ \| |            =
                  =       | ' /| (___ | |  | | |            =
                  =       |  <  \___ \| |  | | |            =
                  =       | . \ ____) | |__| | |____        =
                  =       |_|\_\_____/ \___\_\______|       =
                  =                                         =
                  =  Streaming SQL Engine for Apache Kafka® =
                  ===========================================

Copyright 2017-2018 Confluent Inc.

CLI v5.1.0, Server v5.1.0 located at http://ksql-server:8088

Having trouble? Type 'help' (case-insensitive) for a rundown of how things work!

ksql>
----

This means that the KSQL CLI was able to connect the KSQL Server and therefore, able to present a working prompt.
In the KSQL CLI prompt, enter the following command:

[source,bash]
----
PRINT 'raw-movies' FROM BEGINNING;
----

You should see all the records that you loaded into the topic `raw-movies` previously.
Press kbd:[Ctrl + C] to interrupt the print command and go back to the KSQL CLI prompt, and thereafter type `exit` then `ENTER` to exit the prompt and finish the KSQL CLI session.
